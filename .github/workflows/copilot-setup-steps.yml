name: Copilot Setup and Validation

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  copilot-setup:
    name: Setup GitHub Copilot Environment
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build project
        run: npm run build

      - name: ğŸ§ª Run TypeScript validation
        run: npx tsc --noEmit

      - name: ğŸ” Lint codebase
        run: npm run lint

      - name: âœ¨ Check code formatting
        run: npm run format:check

      - name: ğŸ“‹ Validate Copilot instructions
        run: |
          echo "ğŸ” Validating Copilot instruction files..."

          # Check main instructions file
          if [ -f ".github/copilot-instructions.md" ]; then
            echo "âœ… Main copilot-instructions.md found"
          else
            echo "âŒ Main copilot-instructions.md not found"
            exit 1
          fi

          # Check specific instruction files
          for file in .github/instructions/*.instructions.md; do
            if [ -f "$file" ]; then
              echo "âœ… Found: $file"
            fi
          done

          # Check prompt files
          for file in .github/prompts/*.prompt.md; do
            if [ -f "$file" ]; then
              echo "âœ… Found: $file"
            fi
          done

      - name: ğŸ¯ Validate VS Code settings
        run: |
          echo "ğŸ” Validating VS Code configuration..."

          if [ -f ".vscode/settings.json" ]; then
            echo "âœ… VS Code settings.json found"
            # Validate JSON syntax
            python3 -m json.tool .vscode/settings.json > /dev/null
            echo "âœ… VS Code settings.json is valid JSON"
          else
            echo "âŒ VS Code settings.json not found"
            exit 1
          fi

      - name: ğŸ“Š Project structure validation
        run: |
          echo "ğŸ” Validating project structure..."

          # Check core directories
          directories=("src/core" "src/helpers" "src/selectors" "src/types")
          for dir in "${directories[@]}"; do
            if [ -d "$dir" ]; then
              echo "âœ… Directory found: $dir"
            else
              echo "âŒ Directory missing: $dir"
              exit 1
            fi
          done

          # Check for TypeScript files in each directory
          echo "ğŸ“ Core files:"
          ls -la src/core/*.ts || echo "No TypeScript files in core"

          echo "ğŸ”§ Helper files:"
          ls -la src/helpers/*.ts || echo "No TypeScript files in helpers"

          echo "ğŸ¯ Selector files:"
          ls -la src/selectors/*.ts || echo "No TypeScript files in selectors"

          echo "ğŸ“ Type files:"
          ls -la src/types/*.ts || echo "No TypeScript files in types"

      - name: ğŸ“ˆ Generate Copilot metrics
        run: |
          echo "ğŸ“ˆ Generating project metrics for Copilot..."

          # Count TypeScript files
          ts_files=$(find src -name "*.ts" | wc -l)
          echo "ğŸ“Š TypeScript files: $ts_files"

          # Count lines of code
          loc=$(find src -name "*.ts" -exec wc -l {} + | tail -1 | awk '{print $1}')
          echo "ğŸ“Š Lines of code: $loc"

          # Count exported functions
          exports=$(grep -r "export.*function\|export.*const.*=" src --include="*.ts" | wc -l)
          echo "ğŸ“Š Exported functions/constants: $exports"

          # Generate summary
          echo "
          ## ğŸ“Š Project Summary for Copilot

          - **Language**: TypeScript (ES Modules)
          - **Target**: Node.js 24+ with native TS support
          - **Architecture**: Hierarchical DOM manipulation library
          - **Files**: $ts_files TypeScript files
          - **Code**: $loc lines
          - **Exports**: $exports functions/constants
          - **Specialization**: Monaco Editor & VS Code integration

          ### ğŸ¯ Copilot Optimization Status
          - âœ… Custom instructions configured
          - âœ… VS Code settings optimized
          - âœ… Project structure validated
          - âœ… TypeScript strict mode enabled
          - âœ… ESLint rules configured
          - âœ… Prettier formatting active
          " > copilot-metrics.md

      - name: ğŸ“¤ Upload Copilot configuration
        uses: actions/upload-artifact@v4
        with:
          name: copilot-config
          path: |
            .github/copilot-instructions.md
            .github/instructions/
            .github/prompts/
            .vscode/settings.json
            .vscode/mcp.json
            copilot-metrics.md
          retention-days: 30

  success-notification:
    name: Copilot Setup Success
    runs-on: ubuntu-latest
    needs: copilot-setup
    if: success()

    steps:
      - name: ğŸ‰ Setup completed
        run: |
          echo "ğŸ‰ GitHub Copilot setup completed successfully!"
          echo "
          ## âœ… Setup Complete

          Your Interface Hacking project is now optimized for GitHub Copilot with:

          - ğŸ“ Custom instructions for DOM manipulation patterns
          - ğŸ¯ Specialized selectors for Monaco Editor integration
          - ğŸ”§ Advanced VS Code configuration
          - ğŸš€ Performance optimizations enabled
          - ğŸ›¡ï¸ Security settings configured
          - ğŸ“Š Metrics tracking enabled

          ## ğŸš€ Next Steps

          1. Open the project in VS Code
          2. Ensure GitHub Copilot extension is installed
          3. Sign in to GitHub Copilot
          4. Start coding with enhanced AI assistance!

          ## ğŸ’¡ Usage Tips

          - Use descriptive function names for better suggestions
          - Leverage the custom prompts in .github/prompts/
          - Follow the coding patterns in .github/instructions/
          - Check VS Code settings for Copilot features
          "
